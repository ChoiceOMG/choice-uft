<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUFT DataLayer Compatibility Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .test-form { background: #f9f9f9; padding: 10px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        #results { margin-top: 20px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>CUFT DataLayer Compatibility Test</h1>
    <div id="test-output"></div>
    <div id="results"></div>

    <!-- Mock DataLayer for Testing -->
    <script>
        window.dataLayer = [];
        window.dataLayer.push = function(event) {
            console.log('DataLayer Event:', event);
            document.getElementById('results').innerHTML += 'Event: ' + JSON.stringify(event, null, 2) + '\n\n';
            Array.prototype.push.call(window.dataLayer, event);
        };
    </script>

    <!-- Load the standardized utilities -->
    <script src="assets/cuft-dataLayer-utils.js"></script>

    <!-- Test Script -->
    <script>
        function runTests() {
            const output = document.getElementById('test-output');
            const results = [];

            // Test 1: Check if utilities are loaded
            try {
                if (window.cuftDataLayerUtils) {
                    results.push('<div class="success">✓ DataLayer utilities loaded successfully</div>');
                } else {
                    results.push('<div class="error">✗ DataLayer utilities not found</div>');
                    return;
                }
            } catch (e) {
                results.push('<div class="error">✗ Error loading utilities: ' + e.message + '</div>');
                return;
            }

            // Test 2: Email validation
            try {
                const validEmail = window.cuftDataLayerUtils.validateEmail('test@example.com');
                const invalidEmail = window.cuftDataLayerUtils.validateEmail('invalid-email');

                if (validEmail && !invalidEmail) {
                    results.push('<div class="success">✓ Email validation works correctly</div>');
                } else {
                    results.push('<div class="error">✗ Email validation failed</div>');
                }
            } catch (e) {
                results.push('<div class="error">✗ Email validation error: ' + e.message + '</div>');
            }

            // Test 3: Phone sanitization
            try {
                const sanitized = window.cuftDataLayerUtils.sanitizePhone('(123) 456-7890');
                if (sanitized === '1234567890') {
                    results.push('<div class="success">✓ Phone sanitization works correctly</div>');
                } else {
                    results.push('<div class="error">✗ Phone sanitization failed: got "' + sanitized + '"</div>');
                }
            } catch (e) {
                results.push('<div class="error">✗ Phone sanitization error: ' + e.message + '</div>');
            }

            // Test 4: Framework identifiers
            try {
                const identifiers = window.cuftDataLayerUtils.FRAMEWORK_IDENTIFIERS;
                const expectedFrameworks = ['elementor', 'cf7', 'ninja', 'gravity', 'avada'];
                const foundFrameworks = Object.keys(identifiers);

                let allFound = true;
                for (let framework of expectedFrameworks) {
                    if (!foundFrameworks.includes(framework)) {
                        allFound = false;
                        break;
                    }
                }

                if (allFound) {
                    results.push('<div class="success">✓ All framework identifiers present</div>');
                } else {
                    results.push('<div class="error">✗ Missing framework identifiers</div>');
                }
            } catch (e) {
                results.push('<div class="error">✗ Framework identifiers error: ' + e.message + '</div>');
            }

            // Test 5: Create a mock form and test tracking
            try {
                const mockForm = document.createElement('form');
                mockForm.id = 'test-form';
                mockForm.innerHTML = `
                    <input type="email" name="email" value="test@example.com">
                    <input type="tel" name="phone" value="123-456-7890">
                `;
                document.body.appendChild(mockForm);

                // Mock UTM data
                window.cuftGetTrackingData = function() {
                    return {
                        utm_source: 'test',
                        utm_medium: 'automated',
                        gclid: 'test-click-id'
                    };
                };

                const success = window.cuftDataLayerUtils.trackFormSubmission('elementor', mockForm, {
                    form_id: 'test-form',
                    form_name: 'Test Form',
                    user_email: 'test@example.com',
                    user_phone: '123-456-7890',
                    debug: true
                });

                if (success) {
                    results.push('<div class="success">✓ Form submission tracking works</div>');
                } else {
                    results.push('<div class="error">✗ Form submission tracking failed</div>');
                }

                document.body.removeChild(mockForm);
            } catch (e) {
                results.push('<div class="error">✗ Form tracking test error: ' + e.message + '</div>');
            }

            // Test 6: Cross-framework compatibility (no interference)
            try {
                const testForms = [
                    { class: 'elementor-form', framework: 'elementor' },
                    { class: 'wpcf7-form', framework: 'cf7' },
                    { class: 'nf-form', framework: 'ninja' },
                    { class: 'gform_form', framework: 'gravity' },
                    { class: 'fusion-form', framework: 'avada' }
                ];

                let compatibilityPassed = true;

                testForms.forEach(test => {
                    const form = document.createElement('form');
                    form.className = test.class;
                    document.body.appendChild(form);

                    // Each form should only be processed by its matching framework
                    // This is tested by the silent exit behavior in each framework file

                    document.body.removeChild(form);
                });

                if (compatibilityPassed) {
                    results.push('<div class="success">✓ Cross-framework compatibility maintained</div>');
                }
            } catch (e) {
                results.push('<div class="error">✗ Cross-framework compatibility error: ' + e.message + '</div>');
            }

            output.innerHTML = results.join('');

            // Summary
            const successCount = results.filter(r => r.includes('success')).length;
            const totalTests = results.length;

            output.innerHTML += '<div style="margin-top: 20px; padding: 15px; border: 2px solid ' +
                (successCount === totalTests ? '#28a745' : '#dc3545') + ';">' +
                '<strong>Test Results: ' + successCount + '/' + totalTests + ' passed</strong></div>';
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>