<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Test: Generate Lead Events</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .pending { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        #dataLayerEvents { max-height: 300px; overflow-y: auto; }
        .scenario { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Contract Test: Generate Lead Events</h1>
    <p><strong>Purpose:</strong> Validate that generate_lead events only fire when ALL conditions are met and include correct contract fields</p>

    <div class="test-section">
        <h2>Test Status</h2>
        <div id="testResults"></div>
        <button onclick="runAllTests()">Run All Generate Lead Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="showDataLayerEvents()">Show DataLayer Events</button>
    </div>

    <div class="test-section">
        <h2>Lead Generation Requirements</h2>
        <h3>generate_lead fires ONLY when ALL three conditions are met:</h3>
        <ol>
            <li><strong>Email Address:</strong> Non-empty email field value</li>
            <li><strong>Phone Number:</strong> Non-empty phone field value</li>
            <li><strong>Click ID:</strong> At least one click ID present (gclid, fbclid, click_id, etc.)</li>
        </ol>
        <h3>Required Fields in generate_lead Event:</h3>
        <ul>
            <li><strong>event:</strong> "generate_lead" (exact string)</li>
            <li><strong>currency:</strong> "USD" (string)</li>
            <li><strong>value:</strong> 0 (number)</li>
            <li><strong>cuft_tracked:</strong> true (boolean)</li>
            <li><strong>cuft_source:</strong> framework_name + "_lead" (snake_case)</li>
            <li>All form_submit fields must also be included</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Test Scenarios</h2>

        <div class="scenario">
            <h4>‚úÖ Should Fire Generate Lead:</h4>
            <button onclick="testWithAllRequirements()">Email + Phone + Click ID</button>
            <button onclick="testWithMultipleClickIds()">Email + Phone + Multiple Click IDs</button>
        </div>

        <div class="scenario">
            <h4>‚ùå Should NOT Fire Generate Lead:</h4>
            <button onclick="testEmailOnly()">Email Only (no phone, no click ID)</button>
            <button onclick="testPhoneOnly()">Phone Only (no email, no click ID)</button>
            <button onclick="testClickIdOnly()">Click ID Only (no email, no phone)</button>
            <button onclick="testEmailPhone()">Email + Phone (no click ID)</button>
            <button onclick="testEmailClickId()">Email + Click ID (no phone)</button>
            <button onclick="testPhoneClickId()">Phone + Click ID (no email)</button>
            <button onclick="testEmptyValues()">Empty Values</button>
        </div>

        <div class="scenario">
            <h4>üîç Edge Cases:</h4>
            <button onclick="testInvalidEmail()">Invalid Email Format + Phone + Click ID</button>
            <button onclick="testWhitespaceFields()">Whitespace-only Fields</button>
        </div>
    </div>

    <div class="test-section">
        <h2>DataLayer Events Monitor</h2>
        <div id="dataLayerEvents"></div>
    </div>

    <div class="test-section">
        <h2>Supported Click IDs</h2>
        <ul>
            <li><strong>click_id</strong> - Generic click identifier</li>
            <li><strong>gclid</strong> - Google Ads click ID</li>
            <li><strong>gbraid</strong> - Google iOS campaign tracking</li>
            <li><strong>wbraid</strong> - Google Web-to-App tracking</li>
            <li><strong>fbclid</strong> - Facebook/Meta click ID</li>
            <li><strong>msclkid</strong> - Microsoft/Bing click ID</li>
            <li><strong>ttclid</strong> - TikTok click ID</li>
            <li><strong>li_fat_id</strong> - LinkedIn click ID</li>
            <li><strong>twclid</strong> - Twitter/X click ID</li>
            <li><strong>snap_click_id</strong> - Snapchat click ID</li>
            <li><strong>pclid</strong> - Pinterest click ID</li>
        </ul>
    </div>

    <!-- Mock Framework Elements -->
    <div style="display: none;">
        <form class="elementor-form" id="lead-test-form" data-settings='{"form_id":"lead-test"}'>
            <input type="text" name="form_fields[email]" id="test-email">
            <input type="text" name="form_fields[phone]" id="test-phone">
        </form>
    </div>

    <script>
        // Initialize DataLayer if not exists
        window.dataLayer = window.dataLayer || [];

        // Track all dataLayer events
        var capturedEvents = [];
        var originalPush = window.dataLayer.push.bind(window.dataLayer);

        window.dataLayer.push = function(event) {
            if (event && typeof event === 'object') {
                capturedEvents.push({
                    event: event,
                    timestamp: new Date().toISOString(),
                    testContext: window.currentTestContext || 'unknown'
                });
                updateDataLayerDisplay();
            }
            return originalPush(event);
        };

        // Contract validation functions
        function validateGenerateLeadContract(event) {
            var errors = [];
            var warnings = [];

            // Required fields for generate_lead
            if (event.event !== 'generate_lead') {
                errors.push('event must be "generate_lead", got: ' + event.event);
            }

            if (event.currency !== 'USD') {
                errors.push('currency must be "USD", got: ' + event.currency);
            }

            if (event.value !== 0) {
                errors.push('value must be 0 (number), got: ' + event.value + ' (' + typeof event.value + ')');
            }

            if (event.cuft_tracked !== true) {
                errors.push('cuft_tracked must be true (boolean), got: ' + event.cuft_tracked);
            }

            if (!event.cuft_source || typeof event.cuft_source !== 'string') {
                errors.push('cuft_source must be a non-empty string');
            } else if (event.cuft_source.indexOf('_lead') === -1) {
                errors.push('cuft_source should end with "_lead" for generate_lead events');
            }

            // Should also include all form_submit fields
            var requiredFormFields = ['form_type', 'form_id', 'form_name', 'submitted_at'];
            requiredFormFields.forEach(function(field) {
                if (!event[field] || (typeof event[field] === 'string' && event[field].trim() === '')) {
                    errors.push('Missing required form_submit field: ' + field);
                }
            });

            // Validate lead generation requirements are present
            var hasEmail = event.user_email && typeof event.user_email === 'string' && event.user_email.trim() !== '';
            var hasPhone = event.user_phone && typeof event.user_phone === 'string' && event.user_phone.trim() !== '';

            var clickIdFields = ['click_id', 'gclid', 'gbraid', 'wbraid', 'fbclid', 'msclkid', 'ttclid', 'li_fat_id', 'twclid', 'snap_click_id', 'pclid'];
            var hasClickId = clickIdFields.some(function(field) {
                return event[field] && typeof event[field] === 'string' && event[field].trim() !== '';
            });

            if (!hasEmail) {
                errors.push('generate_lead requires user_email to be present and non-empty');
            }

            if (!hasPhone) {
                errors.push('generate_lead requires user_phone to be present and non-empty');
            }

            if (!hasClickId) {
                errors.push('generate_lead requires at least one click ID to be present');
            }

            return { errors: errors, warnings: warnings };
        }

        function setTestData(email, phone, clickIds, utmParams) {
            var emailInput = document.getElementById('test-email');
            var phoneInput = document.getElementById('test-phone');

            emailInput.value = email || '';
            phoneInput.value = phone || '';

            // Mock UTM and click ID data in sessionStorage (simulating tracking data)
            var trackingData = {
                email: email || '',
                phone: phone || '',
                utm_params: utmParams || {},
                click_ids: clickIds || {}
            };

            try {
                sessionStorage.setItem('cuft_tracking_data', JSON.stringify(trackingData));
            } catch (e) {
                // Fallback for testing
                window.cuftTestTrackingData = trackingData;
            }
        }

        function fireFormSubmitEvent(testName) {
            window.currentTestContext = testName;
            var form = document.getElementById('lead-test-form');
            var event = new CustomEvent('submit_success', {
                bubbles: true,
                detail: {
                    form: form,
                    settings: { form_id: 'lead-test' }
                }
            });
            form.dispatchEvent(event);
        }

        function runLeadTest(testName, email, phone, clickIds, expectGenerateLead) {
            var startEventCount = capturedEvents.length;
            setTestData(email, phone, clickIds);

            try {
                fireFormSubmitEvent(testName);

                setTimeout(function() {
                    var newEvents = capturedEvents.slice(startEventCount);
                    var formSubmitEvents = newEvents.filter(function(item) { return item.event.event === 'form_submit'; });
                    var generateLeadEvents = newEvents.filter(function(item) { return item.event.event === 'generate_lead'; });

                    // Check form_submit event was fired (always expected)
                    if (formSubmitEvents.length === 0) {
                        addTestResult(testName, 'FAIL', 'No form_submit event was captured', null);
                        return;
                    }

                    // Check generate_lead event expectation
                    if (expectGenerateLead) {
                        if (generateLeadEvents.length === 0) {
                            addTestResult(testName, 'FAIL', 'Expected generate_lead event but none was captured', {
                                captured_events: newEvents.map(function(item) { return item.event.event; })
                            });
                            return;
                        }

                        if (generateLeadEvents.length > 1) {
                            addTestResult(testName, 'FAIL', 'Multiple generate_lead events captured (' + generateLeadEvents.length + ')', null);
                            return;
                        }

                        var validation = validateGenerateLeadContract(generateLeadEvents[0].event);
                        if (validation.errors.length > 0) {
                            addTestResult(testName, 'FAIL', 'generate_lead contract validation failed', {
                                errors: validation.errors,
                                warnings: validation.warnings,
                                event: generateLeadEvents[0].event
                            });
                        } else {
                            addTestResult(testName, 'PASS', 'generate_lead event fired correctly', {
                                warnings: validation.warnings,
                                event: generateLeadEvents[0].event
                            });
                        }

                    } else {
                        // Should NOT fire generate_lead
                        if (generateLeadEvents.length > 0) {
                            addTestResult(testName, 'FAIL', 'generate_lead event fired when it should not have', {
                                unexpected_event: generateLeadEvents[0].event,
                                test_data: { email: email, phone: phone, clickIds: clickIds }
                            });
                        } else {
                            addTestResult(testName, 'PASS', 'generate_lead correctly did not fire', {
                                form_submit_fired: true,
                                test_data: { email: email, phone: phone, clickIds: clickIds }
                            });
                        }
                    }
                }, 1000);

            } catch (error) {
                addTestResult(testName, 'ERROR', 'Test execution failed: ' + error.message, { error: error });
            }

            window.currentTestContext = null;
        }

        // Test scenarios
        function testWithAllRequirements() {
            runLeadTest('All Requirements Met', 'test@example.com', '123-456-7890', { gclid: 'test_gclid_123' }, true);
        }

        function testWithMultipleClickIds() {
            runLeadTest('Multiple Click IDs', 'test@multiple.com', '987-654-3210', {
                gclid: 'google_123',
                fbclid: 'facebook_456',
                click_id: 'generic_789'
            }, true);
        }

        function testEmailOnly() {
            runLeadTest('Email Only', 'test@emailonly.com', '', {}, false);
        }

        function testPhoneOnly() {
            runLeadTest('Phone Only', '', '123-456-7890', {}, false);
        }

        function testClickIdOnly() {
            runLeadTest('Click ID Only', '', '', { gclid: 'test_gclid' }, false);
        }

        function testEmailPhone() {
            runLeadTest('Email + Phone (No Click ID)', 'test@noclickid.com', '555-123-4567', {}, false);
        }

        function testEmailClickId() {
            runLeadTest('Email + Click ID (No Phone)', 'test@nophone.com', '', { gclid: 'test_gclid' }, false);
        }

        function testPhoneClickId() {
            runLeadTest('Phone + Click ID (No Email)', '', '444-555-6666', { gclid: 'test_gclid' }, false);
        }

        function testEmptyValues() {
            runLeadTest('Empty Values', '', '', {}, false);
        }

        function testInvalidEmail() {
            runLeadTest('Invalid Email Format', 'invalid-email', '123-456-7890', { gclid: 'test_gclid' }, false);
        }

        function testWhitespaceFields() {
            runLeadTest('Whitespace Fields', '   ', '   ', { gclid: '   ' }, false);
        }

        function runAllTests() {
            clearResults();
            var tests = [
                function() { testWithAllRequirements(); },
                function() { testWithMultipleClickIds(); },
                function() { testEmailOnly(); },
                function() { testPhoneOnly(); },
                function() { testClickIdOnly(); },
                function() { testEmailPhone(); },
                function() { testEmailClickId(); },
                function() { testPhoneClickId(); },
                function() { testEmptyValues(); },
                function() { testInvalidEmail(); },
                function() { testWhitespaceFields(); }
            ];

            tests.forEach(function(test, index) {
                setTimeout(test, index * 2000); // 2 second intervals
            });
        }

        function addTestResult(testName, status, message, details) {
            var resultsDiv = document.getElementById('testResults');
            var resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (status === 'PASS' ? 'pass' : status === 'FAIL' ? 'fail' : 'pending');

            var html = '<strong>' + testName + ':</strong> ' + status + ' - ' + message;

            if (details) {
                if (details.errors && details.errors.length > 0) {
                    html += '<br><strong>Errors:</strong><ul>';
                    details.errors.forEach(function(error) {
                        html += '<li>' + error + '</li>';
                    });
                    html += '</ul>';
                }

                if (details.warnings && details.warnings.length > 0) {
                    html += '<br><strong>Warnings:</strong><ul>';
                    details.warnings.forEach(function(warning) {
                        html += '<li>' + warning + '</li>';
                    });
                    html += '</ul>';
                }

                if (details.event || details.unexpected_event) {
                    var eventToShow = details.event || details.unexpected_event;
                    html += '<br><strong>Event Data:</strong><pre>' + JSON.stringify(eventToShow, null, 2) + '</pre>';
                }

                if (details.test_data) {
                    html += '<br><strong>Test Data:</strong><pre>' + JSON.stringify(details.test_data, null, 2) + '</pre>';
                }
            }

            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            capturedEvents = [];
            updateDataLayerDisplay();

            // Clear test data
            try {
                sessionStorage.removeItem('cuft_tracking_data');
            } catch (e) {}
            window.cuftTestTrackingData = null;
        }

        function updateDataLayerDisplay() {
            var display = document.getElementById('dataLayerEvents');
            if (capturedEvents.length === 0) {
                display.innerHTML = '<em>No events captured yet</em>';
            } else {
                var html = '<h4>Captured Events (' + capturedEvents.length + '):</h4>';
                capturedEvents.forEach(function(item, index) {
                    var eventType = item.event.event || 'unknown';
                    html += '<div><strong>Event ' + (index + 1) + '</strong> (' + eventType + ' - ' + item.testContext + '):';
                    html += '<pre>' + JSON.stringify(item.event, null, 2) + '</pre></div>';
                });
                display.innerHTML = html;
            }
        }

        function showDataLayerEvents() {
            console.log('All captured dataLayer events:', capturedEvents);
            updateDataLayerDisplay();
        }

        // Initial setup
        addTestResult('Generate Lead Contract Test', 'READY', 'Ready to run generate_lead contract tests', null);
    </script>
</body>
</html>