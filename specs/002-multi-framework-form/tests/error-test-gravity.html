<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling Test: Gravity Forms</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .pending { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .error-scenario { margin: 10px 0; padding: 10px; border: 1px solid #ffcccc; border-radius: 4px; background: #fff8f8; }
    </style>
</head>
<body>
    <h1>Error Handling Test: Gravity Forms</h1>
    <p><strong>Purpose:</strong> Verify that Gravity Forms tracking continues to work correctly even when errors occur in multi-page forms, conditional logic, or complex field processing</p>

    <div class="test-section">
        <h2>Test Status</h2>
        <div id="testResults"></div>
        <button onclick="runAllErrorTests()">Run All Error Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="showErrorBoundaryStatus()">Show Error Boundary Status</button>
    </div>

    <div class="test-section">
        <h2>Gravity Forms Error Test Scenarios</h2>

        <div class="error-scenario">
            <h4>üåê Gravity Form Structure Errors</h4>
            <button onclick="testMissingGFormWrapper()">Missing GForm Wrapper</button>
            <button onclick="testInvalidFormID()">Invalid Form ID Detection</button>
            <button onclick="testCorruptedFormInputs()">Corrupted Form Input Elements</button>
            <button onclick="testMissingGravityFormsObject()">Missing Gravity Forms Global Object</button>
        </div>

        <div class="error-scenario">
            <h4>üìÑ Multi-Page & Conditional Logic Errors</h4>
            <button onclick="testMultiPageNavigationError()">Multi-Page Navigation Error</button>
            <button onclick="testConditionalLogicError()">Conditional Logic Field Error</button>
            <button onclick="testPageProgressionError()">Page Progression Tracking Error</button>
            <button onclick="testFinalPageDetectionError()">Final Page Detection Error</button>
        </div>

        <div class="error-scenario">
            <h4>üîç Complex Field Processing Errors</h4>
            <button onclick="testComplexFieldMappingError()">Complex Field Mapping Error</button>
            <button onclick="testMultiPartFieldError()">Multi-Part Field Error</button>
            <button onclick="testFieldCombinationError()">Field Combination Logic Error</button>
            <button onclick="testHiddenFieldError()">Hidden Field Processing Error</button>
        </div>

        <div class="error-scenario">
            <h4>üéØ Submission & Confirmation Errors</h4>
            <button onclick="testSubmissionValidationError()">Submission Validation Error</button>
            <button onclick="testConfirmationRedirectError()">Confirmation Redirect Error</button>
            <button onclick="testAjaxSubmissionError()">AJAX Submission Error</button>
            <button onclick="testFormStateManagementError()">Form State Management Error</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Expected Gravity Forms Behavior</h2>
        <h3>‚úÖ Gravity Forms Error Handling Requirements:</h3>
        <ul>
            <li><strong>Multi-Page Support:</strong> Only track final page submissions with error tolerance</li>
            <li><strong>Complex Field Handling:</strong> Process multi-part fields (name, address) gracefully</li>
            <li><strong>Conditional Logic Resilience:</strong> Handle hidden/visible field changes</li>
            <li><strong>Form ID Extraction:</strong> Multiple methods to detect form IDs from various sources</li>
            <li><strong>Submission Method Agnostic:</strong> Work with both AJAX and standard submissions</li>
            <li><strong>Confirmation Handling:</strong> Detect successful submission across redirect/AJAX patterns</li>
        </ul>
    </div>

    <!-- Mock Gravity Forms Elements -->
    <div style="display: none;">
        <!-- Valid Single-Page Gravity Form -->
        <div class="gform_wrapper" id="gform_wrapper_1">
            <form method="post" id="gform_1" class="gravity-form" data-form-id="1">
                <div class="gform_body">
                    <div class="gfield">
                        <input type="email" name="input_1" id="input_1_1" value="valid@gravity.com" class="medium">
                    </div>
                    <div class="gfield">
                        <input type="text" name="input_2" id="input_1_2" value="123-456-7890" class="medium">
                    </div>
                    <div class="gfield">
                        <input type="text" name="input_3.3" id="input_1_3_3" value="John" placeholder="First Name">
                        <input type="text" name="input_3.6" id="input_1_3_6" value="Doe" placeholder="Last Name">
                    </div>
                </div>
                <div class="gform_footer">
                    <input type="submit" id="gform_submit_button_1" value="Submit" class="gform_button button">
                    <input type="hidden" name="gform_submit" value="1">
                </div>
            </form>
        </div>

        <!-- Multi-Page Gravity Form -->
        <div class="gform_wrapper" id="gform_wrapper_multipage">
            <form method="post" id="gform_multipage" class="gravity-form" data-form-id="multipage">
                <div class="gform_body">
                    <div class="gform_page" id="gform_page_1" style="display: block;">
                        <div class="gfield">
                            <input type="text" name="input_1" value="Page 1 Data">
                        </div>
                        <div class="gform_page_footer">
                            <button type="button" class="gform_next_button">Next</button>
                        </div>
                    </div>
                    <div class="gform_page" id="gform_page_2" style="display: none;">
                        <div class="gfield">
                            <input type="email" name="input_2" value="multipage@gravity.com">
                            <input type="text" name="input_3" value="555-987-6543">
                        </div>
                        <div class="gform_page_footer">
                            <button type="button" class="gform_previous_button">Previous</button>
                            <input type="submit" value="Submit" class="gform_button">
                        </div>
                    </div>
                </div>
                <input type="hidden" name="gform_submit" value="multipage">
                <input type="hidden" name="gform_current_page" value="1">
            </form>
        </div>

        <!-- Gravity Form with Missing Structure -->
        <div class="gform_wrapper" id="gform_wrapper_broken">
            <!-- Missing form element -->
            <div class="gform_body">
                <input type="email" name="input_1" value="broken@gravity.com">
            </div>
        </div>

        <!-- Gravity Form with Conditional Logic -->
        <div class="gform_wrapper" id="gform_wrapper_conditional">
            <form method="post" id="gform_conditional" class="gravity-form" data-form-id="conditional">
                <div class="gform_body">
                    <div class="gfield">
                        <input type="radio" name="input_1" value="yes" id="choice_1_1">
                        <input type="radio" name="input_1" value="no" id="choice_1_2" checked>
                    </div>
                    <div class="gfield" id="field_1_2" style="display: none;">
                        <input type="email" name="input_2" value="conditional@gravity.com">
                    </div>
                    <div class="gfield">
                        <input type="text" name="input_3" value="Always visible phone">
                    </div>
                </div>
                <div class="gform_footer">
                    <input type="submit" value="Submit" class="gform_button">
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize error tracking for Gravity Forms
        var gravityErrorTracker = {
            capturedErrors: [],
            capturedEvents: [],
            originalConsoleError: console.error,
            pageStates: new Map(),
            fieldVisibility: new Map()
        };

        // Track all dataLayer events
        window.dataLayer = window.dataLayer || [];
        var originalPush = window.dataLayer.push.bind(window.dataLayer);

        window.dataLayer.push = function(event) {
            if (event && typeof event === 'object') {
                gravityErrorTracker.capturedEvents.push({
                    event: event,
                    timestamp: new Date().toISOString(),
                    testContext: window.currentTestContext || 'unknown'
                });
            }
            return originalPush(event);
        };

        // Monitor console errors specifically for Gravity Forms
        console.error = function() {
            var message = Array.prototype.slice.call(arguments).join(' ');
            if (message.indexOf('gform') > -1 || message.indexOf('gravity') > -1 || window.currentTestContext) {
                gravityErrorTracker.capturedErrors.push({
                    type: 'console.error',
                    args: Array.prototype.slice.call(arguments),
                    timestamp: new Date().toISOString(),
                    testContext: window.currentTestContext || 'unknown'
                });
            }
            return gravityErrorTracker.originalConsoleError.apply(console, arguments);
        };

        // Gravity Forms-specific test execution framework
        function runGravityErrorTest(testName, errorSetup, formTrigger, expectedBehavior) {
            window.currentTestContext = testName;
            var startErrorCount = gravityErrorTracker.capturedErrors.length;
            var startEventCount = gravityErrorTracker.capturedEvents.length;

            try {
                // Set up the error condition
                if (errorSetup) {
                    errorSetup();
                }

                // Trigger the Gravity form event/action
                formTrigger();

                // Give time for async processing, multi-page navigation, etc.
                setTimeout(function() {
                    var newErrors = gravityErrorTracker.capturedErrors.slice(startErrorCount);
                    var newEvents = gravityErrorTracker.capturedEvents.slice(startEventCount);
                    var formSubmitEvents = newEvents.filter(function(item) {
                        return item.event.event === 'form_submit' && item.event.form_type === 'gravity_forms';
                    });

                    // Evaluate results based on expected behavior
                    var result = evaluateGravityErrorTestResult(testName, newErrors, formSubmitEvents, expectedBehavior);
                    addTestResult(testName, result.status, result.message, result.details);

                    window.currentTestContext = null;
                }, 2500); // Longer timeout for multi-page scenarios

            } catch (error) {
                addTestResult(testName, 'ERROR', 'Gravity test setup failed: ' + error.message, { error: error });
                window.currentTestContext = null;
            }
        }

        function evaluateGravityErrorTestResult(testName, errors, formSubmitEvents, expectedBehavior) {
            var result = { status: 'PENDING', message: '', details: {} };

            var trackingWorked = formSubmitEvents.length > 0;
            var errorsOccurred = errors.length > 0;

            if (expectedBehavior.shouldTrackForm) {
                if (trackingWorked) {
                    // Verify Gravity Forms-specific fields
                    var event = formSubmitEvents[0].event;
                    var hasGravityFields = event.form_type === 'gravity_forms' &&
                                         event.cuft_source &&
                                         event.cuft_source.indexOf('gravity') > -1;

                    if (hasGravityFields) {
                        var multiPageInfo = expectedBehavior.isMultiPage ? ' (multi-page final submission)' : '';
                        result = {
                            status: 'PASS',
                            message: 'Gravity Forms tracking worked correctly despite errors' + multiPageInfo,
                            details: { errors: errors, events: formSubmitEvents, gravity_validated: true }
                        };
                    } else {
                        result = {
                            status: 'FAIL',
                            message: 'Gravity Forms tracking succeeded but missing framework-specific fields',
                            details: { errors: errors, events: formSubmitEvents, missing_fields: true }
                        };
                    }
                } else {
                    if (expectedBehavior.isMultiPage && !expectedBehavior.isFinalPage) {
                        result = {
                            status: 'PASS',
                            message: 'Correctly did not track non-final page of multi-page form',
                            details: { errors: errors, events: formSubmitEvents, multi_page_behavior: true }
                        };
                    } else {
                        result = {
                            status: 'FAIL',
                            message: 'Gravity Forms tracking failed - no form_submit event captured',
                            details: { errors: errors, events: formSubmitEvents }
                        };
                    }
                }
            } else {
                if (!trackingWorked) {
                    result = {
                        status: 'PASS',
                        message: 'Correctly did not track invalid Gravity form (' + errors.length + ' errors as expected)',
                        details: { errors: errors, events: formSubmitEvents }
                    };
                } else {
                    result = {
                        status: 'FAIL',
                        message: 'Unexpectedly tracked invalid Gravity form',
                        details: { errors: errors, events: formSubmitEvents }
                    };
                }
            }

            return result;
        }

        // Gravity Forms-specific error test scenarios
        function testMissingGFormWrapper() {
            runGravityErrorTest('Missing GForm Wrapper', null, function() {
                // Try to submit form without proper wrapper
                var form = document.createElement('form');
                form.id = 'gform_orphan';
                form.className = 'gravity-form';
                var event = new CustomEvent('submit', { bubbles: true });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testInvalidFormID() {
            runGravityErrorTest('Invalid Form ID Detection', function() {
                // Remove form ID attributes
                var form = document.getElementById('gform_1');
                form.removeAttribute('data-form-id');
                form.id = ''; // Invalid ID
            }, function() {
                var form = document.getElementById('gform_1') || document.querySelector('#gform_wrapper_1 form');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testCorruptedFormInputs() {
            runGravityErrorTest('Corrupted Form Input Elements', function() {
                // Mock input access to fail
                var originalQuerySelectorAll = HTMLElement.prototype.querySelectorAll;
                HTMLElement.prototype.querySelectorAll = function(selector) {
                    if (selector && selector.indexOf('input') > -1) {
                        throw new Error('Simulated input query error');
                    }
                    return originalQuerySelectorAll.call(this, selector);
                };
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testMissingGravityFormsObject() {
            runGravityErrorTest('Missing Gravity Forms Global Object', function() {
                // Hide Gravity Forms globals
                window.originalGF = window.gf;
                window.originalGForms = window.gforms;
                window.gf = undefined;
                window.gforms = undefined;
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);

                // Restore globals
                window.gf = window.originalGF;
                window.gforms = window.originalGForms;
            }, { shouldTrackForm: true, shouldHaveErrors: false }); // Should work without globals
        }

        function testMultiPageNavigationError() {
            runGravityErrorTest('Multi-Page Navigation Error', function() {
                // Mock page navigation to fail
                var originalDisplay = Object.getOwnPropertyDescriptor(HTMLElement.prototype, 'style') ||
                                    Object.getOwnPropertyDescriptor(Element.prototype, 'style') ||
                                    { get: function() { return this.getAttribute('style') || {}; } };
                Object.defineProperty(HTMLElement.prototype, 'style', {
                    get: function() {
                        if (this.classList && this.classList.contains('gform_page')) {
                            throw new Error('Simulated page style access error');
                        }
                        return originalDisplay.get.call(this);
                    }
                });
            }, function() {
                simulateMultiPageProgression();
            }, { shouldTrackForm: true, shouldHaveErrors: true, isMultiPage: true, isFinalPage: true });
        }

        function testConditionalLogicError() {
            runGravityErrorTest('Conditional Logic Field Error', function() {
                // Mock conditional field visibility check to fail
                var conditionalField = document.getElementById('field_1_2');
                Object.defineProperty(conditionalField, 'offsetParent', {
                    get: function() {
                        throw new Error('Simulated conditional logic error');
                    }
                });
            }, function() {
                // Show conditional field first
                var radioYes = document.getElementById('choice_1_1');
                radioYes.checked = true;
                document.getElementById('field_1_2').style.display = 'block';

                var form = document.getElementById('gform_conditional');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testPageProgressionError() {
            runGravityErrorTest('Page Progression Tracking Error', function() {
                // Mock page progression tracking to fail
                var originalSetAttribute = Element.prototype.setAttribute;
                Element.prototype.setAttribute = function(name, value) {
                    if (name === 'gform_current_page') {
                        throw new Error('Simulated page tracking error');
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }, function() {
                simulateMultiPageProgression();
            }, { shouldTrackForm: true, shouldHaveErrors: true, isMultiPage: true, isFinalPage: true });
        }

        function testFinalPageDetectionError() {
            runGravityErrorTest('Final Page Detection Error', function() {
                // Mock final page detection to fail
                var originalQuerySelector = Document.prototype.querySelector;
                Document.prototype.querySelector = function(selector) {
                    if (selector && (selector.indexOf('gform_next_button') > -1 || selector.indexOf('gform_previous_button') > -1)) {
                        throw new Error('Simulated page detection error');
                    }
                    return originalQuerySelector.call(this, selector);
                };
            }, function() {
                simulateMultiPageProgression();
            }, { shouldTrackForm: false, shouldHaveErrors: true, isMultiPage: true });
        }

        function testComplexFieldMappingError() {
            runGravityErrorTest('Complex Field Mapping Error', function() {
                // Mock complex field processing to fail
                var nameInputs = document.querySelectorAll('#gform_1 input[name^="input_3"]');
                nameInputs.forEach(function(input) {
                    Object.defineProperty(input, 'name', {
                        get: function() {
                            throw new Error('Simulated complex field access error');
                        }
                    });
                });
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testMultiPartFieldError() {
            runGravityErrorTest('Multi-Part Field Error', function() {
                // Mock multi-part field combination to fail
                var firstNameInput = document.getElementById('input_1_3_3');
                var lastNameInput = document.getElementById('input_1_3_6');
                Object.defineProperty(firstNameInput, 'value', {
                    get: function() {
                        throw new Error('Simulated multi-part field error');
                    }
                });
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: true, shouldHaveErrors: true }); // Should work with other fields
        }

        function testFieldCombinationError() {
            runGravityErrorTest('Field Combination Logic Error', function() {
                // Mock field combination logic to fail
                var originalJoin = Array.prototype.join;
                Array.prototype.join = function(separator) {
                    if (this.length > 0 && typeof this[0] === 'string' && this[0].indexOf('input_') > -1) {
                        throw new Error('Simulated field combination error');
                    }
                    return originalJoin.call(this, separator);
                };
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testHiddenFieldError() {
            runGravityErrorTest('Hidden Field Processing Error', function() {
                // Add hidden field and mock its processing to fail
                var form = document.getElementById('gform_1');
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'input_hidden';
                hiddenInput.value = 'hidden_value';
                Object.defineProperty(hiddenInput, 'type', {
                    get: function() {
                        throw new Error('Simulated hidden field error');
                    }
                });
                form.appendChild(hiddenInput);
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: true, shouldHaveErrors: true }); // Should work with visible fields
        }

        function testSubmissionValidationError() {
            runGravityErrorTest('Submission Validation Error', function() {
                // Mock form validation to fail
                var originalCheckValidity = HTMLFormElement.prototype.checkValidity;
                HTMLFormElement.prototype.checkValidity = function() {
                    if (this.classList && this.classList.contains('gravity-form')) {
                        throw new Error('Simulated validation error');
                    }
                    return originalCheckValidity.call(this);
                };
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: true, shouldHaveErrors: true }); // Should skip validation on error
        }

        function testConfirmationRedirectError() {
            runGravityErrorTest('Confirmation Redirect Error', function() {
                // Mock location access to fail
                var originalLocation = window.location;
                Object.defineProperty(window, 'location', {
                    get: function() {
                        throw new Error('Simulated location access error');
                    }
                });
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);

                // Restore location
                Object.defineProperty(window, 'location', {
                    get: function() { return originalLocation; }
                });
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        function testAjaxSubmissionError() {
            runGravityErrorTest('AJAX Submission Error', function() {
                // Mock AJAX submission to fail
                var OriginalXHR = window.XMLHttpRequest;
                window.XMLHttpRequest = function() {
                    var xhr = new OriginalXHR();
                    var originalSend = xhr.send;
                    xhr.send = function() {
                        if (this.url && this.url.indexOf('gforms') > -1) {
                            throw new Error('Simulated Gravity AJAX error');
                        }
                        return originalSend.apply(this, arguments);
                    };
                    return xhr;
                };
            }, function() {
                var form = document.getElementById('gform_1');
                // Add AJAX indicator
                form.setAttribute('data-ajax', 'true');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        function testFormStateManagementError() {
            runGravityErrorTest('Form State Management Error', function() {
                // Mock form state storage to fail
                var originalSetItem = Storage.prototype.setItem;
                Storage.prototype.setItem = function(key, value) {
                    if (key && key.indexOf('gform') > -1) {
                        throw new Error('Simulated form state storage error');
                    }
                    return originalSetItem.call(this, key, value);
                };
            }, function() {
                var form = document.getElementById('gform_1');
                simulateGravityFormSubmission(form);
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        // Helper functions
        function simulateGravityFormSubmission(form) {
            if (!form) return;

            // Gravity Forms typically uses standard form submission
            var event = new CustomEvent('submit', { bubbles: true });
            form.dispatchEvent(event);

            // Simulate post-submission behavior
            setTimeout(function() {
                // Hide form or show confirmation
                try {
                    var wrapper = form.closest('.gform_wrapper');
                    if (wrapper) {
                        var confirmation = document.createElement('div');
                        confirmation.className = 'gform_confirmation_message';
                        confirmation.innerHTML = 'Thank you! Your submission has been received.';
                        wrapper.appendChild(confirmation);
                        form.style.display = 'none';
                    }
                } catch (e) {
                    // May fail in error scenarios
                }
            }, 1000);
        }

        function simulateMultiPageProgression() {
            var form = document.getElementById('gform_multipage');
            var page1 = document.getElementById('gform_page_1');
            var page2 = document.getElementById('gform_page_2');
            var currentPageInput = form.querySelector('input[name="gform_current_page"]');

            // Step 1: Navigate to page 2
            setTimeout(function() {
                try {
                    page1.style.display = 'none';
                    page2.style.display = 'block';
                    currentPageInput.value = '2';
                } catch (e) {
                    // May fail in error scenarios
                }

                // Step 2: Submit final page
                setTimeout(function() {
                    simulateGravityFormSubmission(form);
                }, 1000);
            }, 500);
        }

        function runAllErrorTests() {
            clearResults();
            var tests = [
                testMissingGFormWrapper,
                testInvalidFormID,
                testCorruptedFormInputs,
                testMissingGravityFormsObject,
                testMultiPageNavigationError,
                testConditionalLogicError,
                testPageProgressionError,
                testFinalPageDetectionError,
                testComplexFieldMappingError,
                testMultiPartFieldError,
                testFieldCombinationError,
                testHiddenFieldError,
                testSubmissionValidationError,
                testConfirmationRedirectError,
                testAjaxSubmissionError,
                testFormStateManagementError
            ];

            tests.forEach(function(test, index) {
                setTimeout(test, index * 4000); // Longer intervals for multi-page testing
            });
        }

        function addTestResult(testName, status, message, details) {
            var resultsDiv = document.getElementById('testResults');
            var resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (status === 'PASS' ? 'pass' : status === 'FAIL' ? 'fail' : 'pending');

            var html = '<strong>' + testName + ':</strong> ' + status + ' - ' + message;

            if (details) {
                if (details.errors && details.errors.length > 0) {
                    html += '<br><strong>Gravity Errors (' + details.errors.length + '):</strong>';
                    details.errors.forEach(function(error, index) {
                        html += '<br>' + (index + 1) + '. ' + (error.message || error.type);
                    });
                }

                if (details.events && details.events.length > 0) {
                    html += '<br><strong>Gravity Events:</strong> ' + details.events.length + ' form_submit events';
                    if (details.gravity_validated) {
                        html += ' üåê Gravity-validated';
                    }
                    if (details.multi_page_behavior) {
                        html += ' üìÑ Multi-page behavior correct';
                    }
                }
            }

            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            gravityErrorTracker.capturedErrors = [];
            gravityErrorTracker.capturedEvents = [];
            gravityErrorTracker.pageStates.clear();
            gravityErrorTracker.fieldVisibility.clear();
        }

        function showErrorBoundaryStatus() {
            if (window.cuftErrorBoundary) {
                var status = window.cuftErrorBoundary.getErrorStatus();
                console.log('Error Boundary Status:', status);
                alert('Error Boundary Status: ' + status.totalErrors + ' total errors');
            } else {
                alert('Error Boundary system not loaded');
            }
        }

        // Initial setup
        addTestResult('Gravity Forms Error Test System', 'READY', 'Ready to run Gravity Forms error handling tests', null);
    </script>
</body>
</html>