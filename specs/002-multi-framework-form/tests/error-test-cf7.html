<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling Test: Contact Form 7</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .pending { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .error-scenario { margin: 10px 0; padding: 10px; border: 1px solid #ffcccc; border-radius: 4px; background: #fff8f8; }
    </style>
</head>
<body>
    <h1>Error Handling Test: Contact Form 7</h1>
    <p><strong>Purpose:</strong> Verify that CF7 form tracking continues to work correctly even when errors occur in other scripts or CF7-specific issues arise</p>

    <div class="test-section">
        <h2>Test Status</h2>
        <div id="testResults"></div>
        <button onclick="runAllErrorTests()">Run All Error Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="showErrorBoundaryStatus()">Show Error Boundary Status</button>
    </div>

    <div class="test-section">
        <h2>CF7-Specific Error Test Scenarios</h2>

        <div class="error-scenario">
            <h4>üìù CF7 Form Structure Errors</h4>
            <button onclick="testMissingContactFormId()">Missing Contact Form ID</button>
            <button onclick="testInvalidCF7Markup()">Invalid CF7 Form Markup</button>
            <button onclick="testCorruptedFormInputs()">Corrupted Form Input Elements</button>
            <button onclick="testMissingWPCF7Object()">Missing WPCF7 Global Object</button>
        </div>

        <div class="error-scenario">
            <h4>üéØ CF7 Event Handling Errors</h4>
            <button onclick="testWPCF7MailSentError()">WPCF7 Mail Sent Event Error</button>
            <button onclick="testInvalidEventDetail()">Invalid Event Detail Object</button>
            <button onclick="testMultipleFormEvents()">Multiple Form Events Conflict</button>
            <button onclick="testEventBubblingError()">Event Bubbling Issues</button>
        </div>

        <div class="error-scenario">
            <h4>üîç CF7 Field Processing Errors</h4>
            <button onclick="testEmailFieldError()">Email Field Processing Error</button>
            <button onclick="testPhoneFieldError()">Phone Field Processing Error</button>
            <button onclick="testCustomFieldError()">Custom Field Name Error</button>
            <button onclick="testFieldValidationError()">Field Validation Error</button>
        </div>

        <div class="error-scenario">
            <h4>‚ö° CF7 Integration Errors</h4>
            <button onclick="testAjaxResponseError()">AJAX Response Processing Error</button>
            <button onclick="testFormDeduplicationError()">Form Deduplication Error</button>
            <button onclick="testMultipleCF7FormsError()">Multiple CF7 Forms on Page Error</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Expected CF7 Behavior</h2>
        <h3>‚úÖ CF7 Error Handling Requirements:</h3>
        <ul>
            <li><strong>WPCF7 Event Resilience:</strong> Handle missing or malformed wpcf7mailsent events</li>
            <li><strong>Field Extraction Fallback:</strong> Multiple methods to extract email/phone fields</li>
            <li><strong>Form ID Detection:</strong> Graceful handling when form ID is missing</li>
            <li><strong>AJAX Error Recovery:</strong> Continue tracking even if AJAX handlers fail</li>
            <li><strong>Silent Framework Detection:</strong> Only process CF7 forms, ignore others silently</li>
            <li><strong>Deduplication Resilience:</strong> Prevent duplicate tracking even with errors</li>
        </ul>
    </div>

    <!-- Mock CF7 Framework Elements -->
    <div style="display: none;">
        <!-- Valid CF7 Form -->
        <div class="wpcf7" id="wpcf7-f123-o1">
            <form action="/wp-json/contact-form-7/v1/contact-forms/123/feedback" method="post" class="wpcf7-form" data-status="init" novalidate="novalidate" data-contact-form-id="123">
                <input type="email" name="your-email" value="valid@cf7.com" class="wpcf7-text wpcf7-email">
                <input type="text" name="your-phone" value="123-456-7890" class="wpcf7-text">
                <input type="text" name="your-name" value="Test User" class="wpcf7-text">
                <input type="submit" value="Send" class="wpcf7-submit">
            </form>
        </div>

        <!-- CF7 Form with Missing ID -->
        <div class="wpcf7" id="wpcf7-missing-id">
            <form class="wpcf7-form" data-status="init">
                <input type="email" name="your-email" value="missing-id@cf7.com">
            </form>
        </div>

        <!-- CF7 Form with Invalid Structure -->
        <div class="wpcf7" id="wpcf7-invalid">
            <div class="wpcf7-form"> <!-- Not a form element -->
                <input type="email" name="your-email" value="invalid@cf7.com">
            </div>
        </div>

        <!-- CF7 Form with Corrupted Fields -->
        <div class="wpcf7" id="wpcf7-corrupted">
            <form class="wpcf7-form" data-contact-form-id="corrupted">
                <!-- No input elements -->
            </form>
        </div>
    </div>

    <script>
        // Initialize error tracking for CF7
        var cf7ErrorTracker = {
            capturedErrors: [],
            capturedEvents: [],
            originalConsoleError: console.error
        };

        // Track all dataLayer events
        window.dataLayer = window.dataLayer || [];
        var originalPush = window.dataLayer.push.bind(window.dataLayer);

        window.dataLayer.push = function(event) {
            if (event && typeof event === 'object') {
                cf7ErrorTracker.capturedEvents.push({
                    event: event,
                    timestamp: new Date().toISOString(),
                    testContext: window.currentTestContext || 'unknown'
                });
            }
            return originalPush(event);
        };

        // Monitor console errors specifically for CF7
        console.error = function() {
            var message = Array.prototype.slice.call(arguments).join(' ');
            if (message.indexOf('wpcf7') > -1 || message.indexOf('cf7') > -1 || window.currentTestContext) {
                cf7ErrorTracker.capturedErrors.push({
                    type: 'console.error',
                    args: Array.prototype.slice.call(arguments),
                    timestamp: new Date().toISOString(),
                    testContext: window.currentTestContext || 'unknown'
                });
            }
            return cf7ErrorTracker.originalConsoleError.apply(console, arguments);
        };

        // CF7-specific test execution framework
        function runCF7ErrorTest(testName, errorSetup, formTrigger, expectedBehavior) {
            window.currentTestContext = testName;
            var startErrorCount = cf7ErrorTracker.capturedErrors.length;
            var startEventCount = cf7ErrorTracker.capturedEvents.length;

            try {
                // Set up the error condition
                if (errorSetup) {
                    errorSetup();
                }

                // Trigger the CF7 form event
                formTrigger();

                // Give time for async processing
                setTimeout(function() {
                    var newErrors = cf7ErrorTracker.capturedErrors.slice(startErrorCount);
                    var newEvents = cf7ErrorTracker.capturedEvents.slice(startEventCount);
                    var formSubmitEvents = newEvents.filter(function(item) {
                        return item.event.event === 'form_submit' && item.event.form_type === 'cf7';
                    });

                    // Evaluate results based on expected behavior
                    var result = evaluateCF7ErrorTestResult(testName, newErrors, formSubmitEvents, expectedBehavior);
                    addTestResult(testName, result.status, result.message, result.details);

                    window.currentTestContext = null;
                }, 1500);

            } catch (error) {
                addTestResult(testName, 'ERROR', 'CF7 test setup failed: ' + error.message, { error: error });
                window.currentTestContext = null;
            }
        }

        function evaluateCF7ErrorTestResult(testName, errors, formSubmitEvents, expectedBehavior) {
            var result = { status: 'PENDING', message: '', details: {} };

            var trackingWorked = formSubmitEvents.length > 0;
            var errorsOccurred = errors.length > 0;

            if (expectedBehavior.shouldTrackForm) {
                if (trackingWorked) {
                    // Verify CF7-specific fields
                    var event = formSubmitEvents[0].event;
                    var hasCF7Fields = event.form_type === 'cf7' && event.cuft_source && event.cuft_source.indexOf('cf7') > -1;

                    if (hasCF7Fields) {
                        result = {
                            status: 'PASS',
                            message: 'CF7 form tracking worked correctly despite errors (' + errors.length + ' errors handled)',
                            details: { errors: errors, events: formSubmitEvents, cf7_validated: true }
                        };
                    } else {
                        result = {
                            status: 'FAIL',
                            message: 'CF7 tracking succeeded but missing CF7-specific fields',
                            details: { errors: errors, events: formSubmitEvents, missing_fields: true }
                        };
                    }
                } else {
                    result = {
                        status: 'FAIL',
                        message: 'CF7 form tracking failed - no form_submit event captured',
                        details: { errors: errors, events: formSubmitEvents }
                    };
                }
            } else {
                if (!trackingWorked) {
                    result = {
                        status: 'PASS',
                        message: 'Correctly did not track invalid CF7 form (' + errors.length + ' errors as expected)',
                        details: { errors: errors, events: formSubmitEvents }
                    };
                } else {
                    result = {
                        status: 'FAIL',
                        message: 'Unexpectedly tracked invalid CF7 form',
                        details: { errors: errors, events: formSubmitEvents }
                    };
                }
            }

            return result;
        }

        // CF7-specific error test scenarios
        function testMissingContactFormId() {
            runCF7ErrorTest('Missing Contact Form ID', null, function() {
                var form = document.querySelector('#wpcf7-missing-id .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: null, // Missing ID
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testInvalidCF7Markup() {
            runCF7ErrorTest('Invalid CF7 Form Markup', null, function() {
                var formDiv = document.querySelector('#wpcf7-invalid .wpcf7-form'); // Not a form element
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 'invalid',
                        inputs: formDiv.querySelectorAll('input')
                    }
                });
                formDiv.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testCorruptedFormInputs() {
            runCF7ErrorTest('Corrupted Form Input Elements', function() {
                // Mock querySelector to return corrupted results
                var originalQuerySelectorAll = HTMLElement.prototype.querySelectorAll;
                HTMLElement.prototype.querySelectorAll = function(selector) {
                    if (selector && (selector.indexOf('email') > -1 || selector.indexOf('phone') > -1)) {
                        throw new Error('Simulated field query error');
                    }
                    return originalQuerySelectorAll.call(this, selector);
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: [] // Empty inputs array
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testMissingWPCF7Object() {
            runCF7ErrorTest('Missing WPCF7 Global Object', function() {
                // Hide any existing WPCF7 object
                window.originalWPCF7 = window.wpcf7;
                window.wpcf7 = undefined;
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);

                // Restore WPCF7 object
                window.wpcf7 = window.originalWPCF7;
            }, { shouldTrackForm: true, shouldHaveErrors: false }); // Should still work without global object
        }

        function testWPCF7MailSentError() {
            runCF7ErrorTest('WPCF7 Mail Sent Event Error', function() {
                // Mock event listener to throw error
                var originalAddEventListener = EventTarget.prototype.addEventListener;
                EventTarget.prototype.addEventListener = function(type, listener, options) {
                    if (type === 'wpcf7mailsent') {
                        var wrappedListener = function() {
                            throw new Error('Simulated wpcf7mailsent handler error');
                        };
                        return originalAddEventListener.call(this, type, wrappedListener, options);
                    }
                    return originalAddEventListener.call(this, type, listener, options);
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testInvalidEventDetail() {
            runCF7ErrorTest('Invalid Event Detail Object', null, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: null // Invalid detail object
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testMultipleFormEvents() {
            runCF7ErrorTest('Multiple Form Events Conflict', null, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');

                // Fire multiple events rapidly
                for (var i = 0; i < 5; i++) {
                    var event = new CustomEvent('wpcf7mailsent', {
                        bubbles: true,
                        detail: {
                            contactFormId: 123,
                            inputs: form.querySelectorAll('input')
                        }
                    });
                    form.dispatchEvent(event);
                }
            }, { shouldTrackForm: true, shouldHaveErrors: false }); // Should deduplicate properly
        }

        function testEventBubblingError() {
            runCF7ErrorTest('Event Bubbling Issues', function() {
                // Mock event stopPropagation to cause issues
                var OriginalEvent = window.Event;
                window.Event = function() {
                    var event = new OriginalEvent(...arguments);
                    event.stopPropagation = function() {
                        throw new Error('Simulated stopPropagation error');
                    };
                    return event;
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        function testEmailFieldError() {
            runCF7ErrorTest('Email Field Processing Error', function() {
                // Mock email field to cause processing error
                var emailInput = document.querySelector('#wpcf7-f123-o1 input[name="your-email"]');
                Object.defineProperty(emailInput, 'value', {
                    get: function() {
                        throw new Error('Simulated email field access error');
                    }
                });
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testPhoneFieldError() {
            runCF7ErrorTest('Phone Field Processing Error', function() {
                // Mock phone field to cause processing error
                var phoneInput = document.querySelector('#wpcf7-f123-o1 input[name="your-phone"]');
                Object.defineProperty(phoneInput, 'value', {
                    get: function() {
                        throw new Error('Simulated phone field access error');
                    }
                });
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: false, shouldHaveErrors: true });
        }

        function testCustomFieldError() {
            runCF7ErrorTest('Custom Field Name Error', function() {
                // Mock field with invalid name attribute
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var customInput = document.createElement('input');
                customInput.type = 'text';
                customInput.value = 'custom@value.com';
                Object.defineProperty(customInput, 'name', {
                    get: function() {
                        throw new Error('Simulated name attribute error');
                    }
                });
                form.appendChild(customInput);
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: true, shouldHaveErrors: true }); // Should still work with other fields
        }

        function testFieldValidationError() {
            runCF7ErrorTest('Field Validation Error', function() {
                // Mock email validation to fail
                var originalTest = RegExp.prototype.test;
                RegExp.prototype.test = function(str) {
                    if (this.source.indexOf('email') > -1 || this.source.indexOf('@') > -1) {
                        throw new Error('Simulated email validation error');
                    }
                    return originalTest.call(this, str);
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: true, shouldHaveErrors: true }); // Should track with basic validation
        }

        function testAjaxResponseError() {
            runCF7ErrorTest('AJAX Response Processing Error', function() {
                // Mock JSON.parse to fail
                var originalParse = JSON.parse;
                JSON.parse = function(text) {
                    if (text && text.indexOf('wpcf7') > -1) {
                        throw new Error('Simulated JSON parse error');
                    }
                    return originalParse.call(JSON, text);
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        function testFormDeduplicationError() {
            runCF7ErrorTest('Form Deduplication Error', function() {
                // Mock setAttribute to fail (used for deduplication)
                var originalSetAttribute = Element.prototype.setAttribute;
                Element.prototype.setAttribute = function(name, value) {
                    if (name && name.indexOf('cuft') > -1) {
                        throw new Error('Simulated setAttribute error');
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }, function() {
                var form = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var event = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: {
                        contactFormId: 123,
                        inputs: form.querySelectorAll('input')
                    }
                });
                form.dispatchEvent(event);
            }, { shouldTrackForm: true, shouldHaveErrors: true });
        }

        function testMultipleCF7FormsError() {
            runCF7ErrorTest('Multiple CF7 Forms on Page Error', function() {
                // Create conflicting form IDs
                var form1 = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var form2 = document.querySelector('#wpcf7-missing-id .wpcf7-form');
                form2.setAttribute('data-contact-form-id', '123'); // Same ID as form1
            }, function() {
                // Trigger both forms
                var form1 = document.querySelector('#wpcf7-f123-o1 .wpcf7-form');
                var form2 = document.querySelector('#wpcf7-missing-id .wpcf7-form');

                var event1 = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: { contactFormId: 123, inputs: form1.querySelectorAll('input') }
                });

                var event2 = new CustomEvent('wpcf7mailsent', {
                    bubbles: true,
                    detail: { contactFormId: 123, inputs: form2.querySelectorAll('input') }
                });

                form1.dispatchEvent(event1);
                setTimeout(function() { form2.dispatchEvent(event2); }, 100);
            }, { shouldTrackForm: true, shouldHaveErrors: false }); // Should handle multiple forms correctly
        }

        function runAllErrorTests() {
            clearResults();
            var tests = [
                testMissingContactFormId,
                testInvalidCF7Markup,
                testCorruptedFormInputs,
                testMissingWPCF7Object,
                testWPCF7MailSentError,
                testInvalidEventDetail,
                testMultipleFormEvents,
                testEventBubblingError,
                testEmailFieldError,
                testPhoneFieldError,
                testCustomFieldError,
                testFieldValidationError,
                testAjaxResponseError,
                testFormDeduplicationError,
                testMultipleCF7FormsError
            ];

            tests.forEach(function(test, index) {
                setTimeout(test, index * 3000);
            });
        }

        function addTestResult(testName, status, message, details) {
            var resultsDiv = document.getElementById('testResults');
            var resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (status === 'PASS' ? 'pass' : status === 'FAIL' ? 'fail' : 'pending');

            var html = '<strong>' + testName + ':</strong> ' + status + ' - ' + message;

            if (details) {
                if (details.errors && details.errors.length > 0) {
                    html += '<br><strong>CF7 Errors (' + details.errors.length + '):</strong>';
                    details.errors.forEach(function(error, index) {
                        html += '<br>' + (index + 1) + '. ' + (error.message || error.type);
                    });
                }

                if (details.events && details.events.length > 0) {
                    html += '<br><strong>CF7 Events:</strong> ' + details.events.length + ' form_submit events';
                    if (details.cf7_validated) {
                        html += ' ‚úÖ CF7-validated';
                    }
                }
            }

            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            cf7ErrorTracker.capturedErrors = [];
            cf7ErrorTracker.capturedEvents = [];
        }

        function showErrorBoundaryStatus() {
            if (window.cuftErrorBoundary) {
                var status = window.cuftErrorBoundary.getErrorStatus();
                console.log('Error Boundary Status:', status);
                alert('Error Boundary Status: ' + status.totalErrors + ' total errors');
            } else {
                alert('Error Boundary system not loaded');
            }
        }

        // Initial setup
        addTestResult('CF7 Error Test System', 'READY', 'Ready to run CF7-specific error handling tests', null);
    </script>
</body>
</html>