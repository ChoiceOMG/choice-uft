<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Benchmark Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .perf-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0; }
        .perf-card { padding: 12px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; }
        .benchmark-scenario { margin: 10px 0; padding: 10px; border: 1px solid #cce5ff; border-radius: 4px; background: #f8fcff; }
        .timing-chart { width: 100%; height: 200px; border: 1px solid #ddd; margin: 10px 0; background: #f8f9fa; position: relative; overflow: hidden; }
        .chart-bar { position: absolute; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 2px; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .threshold-line { position: absolute; border-top: 2px dashed #dc3545; width: 100%; z-index: 10; }
        .metric-value { font-size: 18px; font-weight: bold; }
        .metric-label { font-size: 12px; color: #666; }
        .metric-status { font-size: 12px; font-weight: bold; }
        .metric-pass { color: #28a745; }
        .metric-fail { color: #dc3545; }
        .metric-warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>Performance Benchmark Test</h1>
    <p><strong>Purpose:</strong> Benchmark form tracking performance against constitutional compliance targets and validate optimization improvements</p>

    <div class="test-section">
        <h2>Test Control</h2>
        <button onclick="startPerformanceBenchmark()">Start Performance Benchmark</button>
        <button onclick="runAllBenchmarkScenarios()">Run All Benchmark Scenarios</button>
        <button onclick="runStressTest()">Run Stress Test</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="exportBenchmarkReport()">Export Benchmark Report</button>
    </div>

    <div class="test-section">
        <h2>Performance Metrics</h2>
        <div class="perf-stats" id="performanceStats"></div>
        <div class="timing-chart" id="timingChart"></div>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Performance Benchmark Scenarios</h2>

        <div class="benchmark-scenario">
            <h4>‚ö° Core Performance Benchmarks</h4>
            <button onclick="testFormProcessingSpeed()">Form Processing Speed Test</button>
            <button onclick="testFormDetectionSpeed()">Form Detection Speed Test</button>
            <button onclick="testFieldExtractionSpeed()">Field Extraction Speed Test</button>
            <button onclick="testEventProcessingSpeed()">Event Processing Speed Test</button>
        </div>

        <div class="benchmark-scenario">
            <h4>üìä Framework Performance Comparison</h4>
            <button onclick="benchmarkElementorPerformance()">Elementor Performance Benchmark</button>
            <button onclick="benchmarkCF7Performance()">CF7 Performance Benchmark</button>
            <button onclick="benchmarkNinjaPerformance()">Ninja Forms Performance Benchmark</button>
            <button onclick="benchmarkGravityPerformance()">Gravity Forms Performance Benchmark</button>
            <button onclick="benchmarkAvadaPerformance()">Avada Performance Benchmark</button>
        </div>

        <div class="benchmark-scenario">
            <h4>üîç Observer Performance Tests</h4>
            <button onclick="testObserverSetupSpeed()">Observer Setup Speed Test</button>
            <button onclick="testObserverCleanupSpeed()">Observer Cleanup Speed Test</button>
            <button onclick="testScopedObserverPerformance()">Scoped Observer Performance</button>
            <button onclick="testObserverScalingPerformance()">Observer Scaling Performance</button>
        </div>

        <div class="benchmark-scenario">
            <h4>üöÄ Optimization Validation Tests</h4>
            <button onclick="testMemoryOptimization()">Memory Usage Optimization</button>
            <button onclick="testCachingPerformance()">Caching Performance Test</button>
            <button onclick="testRetryLogicPerformance()">Retry Logic Performance</button>
            <button onclick="testErrorBoundaryPerformance()">Error Boundary Performance</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Constitutional Compliance Targets</h2>
        <div class="perf-card">
            <h4>üéØ Performance Requirements</h4>
            <ul>
                <li><strong>Total Form Processing:</strong> &lt; 30ms (target improvement from ~48ms)</li>
                <li><strong>Form Detection:</strong> &lt; 3ms per form</li>
                <li><strong>Field Extraction:</strong> &lt; 10ms per form</li>
                <li><strong>Event Processing:</strong> &lt; 15ms per event</li>
                <li><strong>Observer Setup:</strong> &lt; 5ms per observer</li>
                <li><strong>Memory Usage:</strong> &lt; 1KB per form (target improvement from ~2KB)</li>
                <li><strong>Memory Cleanup:</strong> 100% observer cleanup within timeout periods</li>
                <li><strong>Error Recovery:</strong> &lt; 5ms additional overhead for error boundary</li>
            </ul>
        </div>
    </div>

    <!-- Mock Performance Test Forms -->
    <div style="display: none;" id="performance-test-forms">
        <!-- Forms will be dynamically created for performance testing -->
    </div>

    <script>
        // Performance benchmark system
        var performanceBenchmark = {
            isRunning: false,
            results: [],
            measurements: new Map(),
            thresholds: {
                formProcessing: 30,    // <30ms total processing
                formDetection: 3,      // <3ms form detection
                fieldExtraction: 10,   // <10ms field extraction
                eventProcessing: 15,   // <15ms event processing
                observerSetup: 5,      // <5ms observer setup
                memoryPerForm: 1024,   // <1KB per form
                errorBoundaryOverhead: 5  // <5ms error boundary overhead
            },
            systemAvailable: {
                performanceMonitor: false,
                observerCleanup: false,
                errorBoundary: false,
                retryLogic: false
            },
            testIterations: 10, // Number of iterations for each test
            warmupIterations: 3 // Warmup iterations before measurement
        };

        // Check system availability
        function checkSystemAvailability() {
            performanceBenchmark.systemAvailable = {
                performanceMonitor: !!(window.cuftPerformanceMonitor),
                observerCleanup: !!(window.cuftObserverCleanup),
                errorBoundary: !!(window.cuftErrorBoundary),
                retryLogic: !!(window.cuftRetryLogic)
            };

            var availableCount = Object.values(performanceBenchmark.systemAvailable).filter(Boolean).length;
            var totalSystems = Object.keys(performanceBenchmark.systemAvailable).length;

            addTestResult('System Availability Check', 'INFO',
                availableCount + '/' + totalSystems + ' performance systems available for testing');

            return performanceBenchmark.systemAvailable;
        }

        // High-precision timing utilities
        function startTiming(name) {
            var start = performance.now();

            return {
                name: name,
                start: start,
                end: function() {
                    var end = performance.now();
                    var duration = end - start;

                    if (!performanceBenchmark.measurements.has(name)) {
                        performanceBenchmark.measurements.set(name, []);
                    }
                    performanceBenchmark.measurements.get(name).push(duration);

                    return duration;
                }
            };
        }

        function measureAsyncOperation(name, operation, iterations) {
            return new Promise(function(resolve) {
                var measurements = [];
                var currentIteration = 0;

                function runIteration() {
                    if (currentIteration >= iterations) {
                        resolve(measurements);
                        return;
                    }

                    var timer = startTiming(name);

                    // Wrap operation in performance measurement
                    var operationPromise;
                    try {
                        operationPromise = Promise.resolve(operation());
                    } catch (e) {
                        operationPromise = Promise.resolve();
                    }

                    operationPromise.then(function() {
                        var duration = timer.end();
                        measurements.push(duration);
                        currentIteration++;

                        // Small delay between iterations
                        setTimeout(runIteration, 10);
                    }).catch(function() {
                        var duration = timer.end();
                        measurements.push(duration);
                        currentIteration++;
                        setTimeout(runIteration, 10);
                    });
                }

                runIteration();
            });
        }

        function calculateStatistics(measurements) {
            if (measurements.length === 0) {
                return { avg: 0, min: 0, max: 0, median: 0, p95: 0, p99: 0 };
            }

            var sorted = measurements.slice().sort(function(a, b) { return a - b; });
            var sum = measurements.reduce(function(a, b) { return a + b; }, 0);

            return {
                avg: sum / measurements.length,
                min: sorted[0],
                max: sorted[sorted.length - 1],
                median: sorted[Math.floor(sorted.length / 2)],
                p95: sorted[Math.floor(sorted.length * 0.95)],
                p99: sorted[Math.floor(sorted.length * 0.99)],
                count: measurements.length
            };
        }

        // Performance test scenarios
        function testFormProcessingSpeed() {
            runBenchmarkTest('Form Processing Speed', function() {
                return measureAsyncOperation('form-processing', function() {
                    var container = document.getElementById('performance-test-forms');

                    // Create form
                    var form = document.createElement('form');
                    form.className = 'elementor-form';
                    form.setAttribute('data-settings', '{"form_id":"perf-test"}');

                    var emailInput = document.createElement('input');
                    emailInput.name = 'form_fields[email]';
                    emailInput.value = 'perf-test@example.com';

                    var phoneInput = document.createElement('input');
                    phoneInput.name = 'form_fields[phone]';
                    phoneInput.value = '123-456-7890';

                    form.appendChild(emailInput);
                    form.appendChild(phoneInput);
                    container.appendChild(form);

                    // Simulate complete form processing pipeline
                    var event = new CustomEvent('submit_success', {
                        bubbles: true,
                        detail: { form: form, settings: { form_id: 'perf-test' } }
                    });

                    form.dispatchEvent(event);

                    // Cleanup
                    setTimeout(function() {
                        if (form.parentNode) {
                            form.parentNode.removeChild(form);
                        }
                    }, 50);

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.formProcessing);
        }

        function testFormDetectionSpeed() {
            runBenchmarkTest('Form Detection Speed', function() {
                return measureAsyncOperation('form-detection', function() {
                    var container = document.getElementById('performance-test-forms');

                    // Create multiple forms to detect
                    var forms = [];
                    for (var i = 0; i < 5; i++) {
                        var form = document.createElement('form');
                        form.className = 'elementor-form test-form-' + i;
                        form.id = 'detection-test-' + i;
                        container.appendChild(form);
                        forms.push(form);
                    }

                    // Simulate form detection logic
                    var detectedForms = container.querySelectorAll('.elementor-form');
                    var validForms = Array.prototype.filter.call(detectedForms, function(form) {
                        return form.classList.contains('elementor-form') &&
                               form.id && form.id.indexOf('detection-test') === 0;
                    });

                    // Cleanup
                    forms.forEach(function(form) {
                        if (form.parentNode) {
                            form.parentNode.removeChild(form);
                        }
                    });

                    return validForms.length;

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.formDetection);
        }

        function testFieldExtractionSpeed() {
            runBenchmarkTest('Field Extraction Speed', function() {
                return measureAsyncOperation('field-extraction', function() {
                    var container = document.getElementById('performance-test-forms');

                    // Create form with multiple fields
                    var form = document.createElement('form');
                    form.className = 'elementor-form';

                    var fields = [
                        { name: 'form_fields[email]', value: 'extraction@test.com', type: 'email' },
                        { name: 'form_fields[phone]', value: '555-123-4567', type: 'text' },
                        { name: 'form_fields[name]', value: 'Test User', type: 'text' },
                        { name: 'form_fields[company]', value: 'Test Company', type: 'text' },
                        { name: 'form_fields[message]', value: 'Test message content', type: 'textarea' }
                    ];

                    fields.forEach(function(fieldDef) {
                        var input = document.createElement(fieldDef.type === 'textarea' ? 'textarea' : 'input');
                        if (fieldDef.type !== 'textarea') {
                            input.type = fieldDef.type;
                        }
                        input.name = fieldDef.name;
                        input.value = fieldDef.value;
                        form.appendChild(input);
                    });

                    container.appendChild(form);

                    // Simulate field extraction
                    var extractedFields = {};
                    var inputs = form.querySelectorAll('input, textarea');
                    for (var i = 0; i < inputs.length; i++) {
                        var input = inputs[i];
                        if (input.name && input.value) {
                            var fieldName = input.name.replace(/form_fields\[(.*?)\]/, '$1');
                            extractedFields[fieldName] = input.value;
                        }
                    }

                    // Cleanup
                    if (form.parentNode) {
                        form.parentNode.removeChild(form);
                    }

                    return Object.keys(extractedFields).length;

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.fieldExtraction);
        }

        function testEventProcessingSpeed() {
            runBenchmarkTest('Event Processing Speed', function() {
                return measureAsyncOperation('event-processing', function() {
                    var container = document.getElementById('performance-test-forms');

                    var form = document.createElement('form');
                    form.className = 'elementor-form';
                    container.appendChild(form);

                    // Simulate event processing with dataLayer push
                    var eventData = {
                        event: 'form_submit',
                        form_type: 'elementor',
                        form_id: 'event-processing-test',
                        form_name: 'Event Processing Test',
                        user_email: 'event@test.com',
                        user_phone: '555-987-6543',
                        submitted_at: new Date().toISOString(),
                        cuft_tracked: true,
                        cuft_source: 'elementor_pro'
                    };

                    // Simulate dataLayer processing
                    if (window.dataLayer) {
                        window.dataLayer.push(eventData);
                    }

                    // Cleanup
                    if (form.parentNode) {
                        form.parentNode.removeChild(form);
                    }

                    return eventData;

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.eventProcessing);
        }

        function benchmarkElementorPerformance() {
            runFrameworkBenchmark('Elementor', 'elementor-form', 'submit_success', {
                form_fields: {
                    email: 'elementor@benchmark.com',
                    phone: '555-elementor-1'
                }
            });
        }

        function benchmarkCF7Performance() {
            runFrameworkBenchmark('CF7', 'wpcf7-form', 'wpcf7mailsent', {
                'your-email': 'cf7@benchmark.com',
                'your-phone': '555-cf7-test-1'
            });
        }

        function benchmarkNinjaPerformance() {
            runFrameworkBenchmark('Ninja Forms', 'ninja-forms-form', 'submit', {
                email_123: 'ninja@benchmark.com',
                phone_456: '555-ninja-123'
            });
        }

        function benchmarkGravityPerformance() {
            runFrameworkBenchmark('Gravity Forms', 'gravity-form', 'submit', {
                input_1: 'gravity@benchmark.com',
                input_2: '555-gravity-1'
            });
        }

        function benchmarkAvadaPerformance() {
            runFrameworkBenchmark('Avada', 'fusion-form', 'submit', {
                email: 'avada@benchmark.com',
                phone: '555-avada-test'
            });
        }

        function runFrameworkBenchmark(frameworkName, formClass, eventType, fieldData) {
            runBenchmarkTest(frameworkName + ' Framework Benchmark', function() {
                return measureAsyncOperation('framework-' + frameworkName.toLowerCase(), function() {
                    var container = document.getElementById('performance-test-forms');

                    // Create framework-specific form
                    var form = document.createElement('form');
                    form.className = formClass;
                    form.id = frameworkName.toLowerCase() + '-benchmark-form';

                    // Add form fields
                    Object.keys(fieldData).forEach(function(fieldName) {
                        var input = document.createElement('input');
                        input.name = fieldName;
                        input.value = fieldData[fieldName];
                        input.type = fieldName.indexOf('email') > -1 ? 'email' : 'text';
                        form.appendChild(input);
                    });

                    container.appendChild(form);

                    // Trigger framework-specific event
                    var event = new CustomEvent(eventType, {
                        bubbles: true,
                        detail: frameworkName === 'Elementor' ? {
                            form: form,
                            settings: { form_id: 'benchmark-form' }
                        } : frameworkName === 'CF7' ? {
                            contactFormId: 'benchmark',
                            inputs: form.querySelectorAll('input')
                        } : null
                    });

                    form.dispatchEvent(event);

                    // Cleanup
                    setTimeout(function() {
                        if (form.parentNode) {
                            form.parentNode.removeChild(form);
                        }
                    }, 25);

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.formProcessing);
        }

        function testObserverSetupSpeed() {
            runBenchmarkTest('Observer Setup Speed', function() {
                return measureAsyncOperation('observer-setup', function() {
                    var container = document.getElementById('performance-test-forms');
                    var target = document.createElement('div');
                    target.id = 'observer-setup-target';
                    container.appendChild(target);

                    var observer;
                    var setupTime = startTiming('observer-creation');

                    if (performanceBenchmark.systemAvailable.observerCleanup) {
                        // Use scoped observer system
                        observer = window.cuftObserverCleanup.createScopedObserver(
                            target,
                            function() { console.log('Setup benchmark observer'); },
                            { timeout: 1000, context: 'Setup Benchmark' }
                        );
                    } else {
                        // Fallback to standard observer
                        observer = new MutationObserver(function() {
                            console.log('Standard observer callback');
                        });
                        observer.observe(target, { childList: true });
                    }

                    var duration = setupTime.end();

                    // Cleanup
                    setTimeout(function() {
                        if (observer) {
                            if (observer.disconnect) {
                                observer.disconnect();
                            } else if (observer.observer && observer.observer.disconnect) {
                                observer.observer.disconnect();
                            }
                        }
                        if (target.parentNode) {
                            target.parentNode.removeChild(target);
                        }
                    }, 100);

                    return duration;

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.observerSetup);
        }

        function testObserverCleanupSpeed() {
            runBenchmarkTest('Observer Cleanup Speed', function() {
                return measureAsyncOperation('observer-cleanup', function() {
                    var container = document.getElementById('performance-test-forms');
                    var target = document.createElement('div');
                    container.appendChild(target);

                    // Create observer
                    var observer;
                    if (performanceBenchmark.systemAvailable.observerCleanup) {
                        observer = window.cuftObserverCleanup.createScopedObserver(
                            target,
                            function() { console.log('Cleanup benchmark observer'); },
                            { timeout: 5000, context: 'Cleanup Benchmark' }
                        );
                    } else {
                        observer = new MutationObserver(function() {});
                        observer.observe(target, { childList: true });
                    }

                    // Measure cleanup time
                    var cleanupTime = startTiming('observer-cleanup');

                    if (observer && observer.disconnect) {
                        observer.disconnect();
                    } else if (observer && observer.observer) {
                        observer.observer.disconnect();
                    }

                    var duration = cleanupTime.end();

                    // Cleanup target
                    if (target.parentNode) {
                        target.parentNode.removeChild(target);
                    }

                    return duration;

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.observerSetup);
        }

        function testScopedObserverPerformance() {
            if (!performanceBenchmark.systemAvailable.observerCleanup) {
                addTestResult('Scoped Observer Performance', 'SKIP', 'Observer cleanup system not available');
                return;
            }

            runBenchmarkTest('Scoped Observer Performance', function() {
                return measureAsyncOperation('scoped-observer-perf', function() {
                    var container = document.getElementById('performance-test-forms');
                    var target = document.createElement('div');
                    container.appendChild(target);

                    // Full scoped observer lifecycle
                    var observer = window.cuftObserverCleanup.createScopedObserver(
                        target,
                        function() { console.log('Scoped perf test'); },
                        { timeout: 2000, context: 'Scoped Performance Test' }
                    );

                    // Trigger observer
                    target.appendChild(document.createElement('span'));

                    // Manual cleanup
                    if (observer && observer.disconnect) {
                        observer.disconnect();
                    }

                    // Cleanup target
                    if (target.parentNode) {
                        target.parentNode.removeChild(target);
                    }

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.observerSetup);
        }

        function testObserverScalingPerformance() {
            runBenchmarkTest('Observer Scaling Performance', function() {
                return measureAsyncOperation('observer-scaling', function() {
                    var container = document.getElementById('performance-test-forms');
                    var observers = [];

                    // Create multiple observers simultaneously
                    for (var i = 0; i < 10; i++) {
                        var target = document.createElement('div');
                        target.id = 'scaling-target-' + i;
                        container.appendChild(target);

                        var observer;
                        if (performanceBenchmark.systemAvailable.observerCleanup) {
                            observer = window.cuftObserverCleanup.createScopedObserver(
                                target,
                                function() { console.log('Scaling observer'); },
                                { timeout: 1000, context: 'Scaling Test ' + i }
                            );
                        } else {
                            observer = new MutationObserver(function() {});
                            observer.observe(target, { childList: true });
                        }

                        if (observer) {
                            observers.push({ observer: observer, target: target });
                        }
                    }

                    // Trigger all observers
                    observers.forEach(function(item) {
                        item.target.appendChild(document.createElement('span'));
                    });

                    // Cleanup all observers
                    observers.forEach(function(item) {
                        if (item.observer.disconnect) {
                            item.observer.disconnect();
                        } else if (item.observer.observer) {
                            item.observer.observer.disconnect();
                        }
                        if (item.target.parentNode) {
                            item.target.parentNode.removeChild(item.target);
                        }
                    });

                    return observers.length;

                }, Math.floor(performanceBenchmark.testIterations / 2));
            }, performanceBenchmark.thresholds.observerSetup * 10);
        }

        function testMemoryOptimization() {
            runBenchmarkTest('Memory Usage Optimization', function() {
                return new Promise(function(resolve) {
                    var measurements = [];
                    var iterations = 5;
                    var currentIteration = 0;

                    function runMemoryTest() {
                        if (currentIteration >= iterations) {
                            resolve(measurements);
                            return;
                        }

                        var beforeMemory = getMemoryUsage();
                        var timer = startTiming('memory-optimization');

                        // Create multiple forms and process them
                        var container = document.getElementById('performance-test-forms');
                        var forms = [];

                        for (var i = 0; i < 20; i++) {
                            var form = document.createElement('form');
                            form.className = 'elementor-form memory-test-' + i;

                            var emailInput = document.createElement('input');
                            emailInput.name = 'form_fields[email]';
                            emailInput.value = 'memory-test-' + i + '@example.com';

                            form.appendChild(emailInput);
                            container.appendChild(form);
                            forms.push(form);

                            // Trigger form processing
                            var event = new CustomEvent('submit_success', {
                                bubbles: true,
                                detail: { form: form, settings: { form_id: 'memory-test-' + i } }
                            });
                            form.dispatchEvent(event);
                        }

                        var duration = timer.end();

                        // Cleanup forms
                        forms.forEach(function(form) {
                            if (form.parentNode) {
                                form.parentNode.removeChild(form);
                            }
                        });

                        // Force garbage collection if available
                        if (window.gc) {
                            window.gc();
                        }

                        var afterMemory = getMemoryUsage();
                        var memoryDelta = afterMemory - beforeMemory;

                        measurements.push({
                            duration: duration,
                            memoryDelta: memoryDelta,
                            memoryPerForm: memoryDelta / forms.length
                        });

                        currentIteration++;
                        setTimeout(runMemoryTest, 500);
                    }

                    runMemoryTest();
                });
            }, performanceBenchmark.thresholds.memoryPerForm, 'memory');
        }

        function testCachingPerformance() {
            runBenchmarkTest('Caching Performance', function() {
                return measureAsyncOperation('caching-performance', function() {
                    // Simulate caching scenario
                    var cache = new Map();
                    var data = {
                        form_id: 'cache-test-' + Date.now(),
                        timestamp: new Date().toISOString(),
                        fields: {
                            email: 'cache@test.com',
                            phone: '555-cache-123'
                        }
                    };

                    // Cache write
                    cache.set(data.form_id, data);

                    // Cache read
                    var cachedData = cache.get(data.form_id);

                    // Cache cleanup
                    cache.delete(data.form_id);

                    return cachedData ? 1 : 0;

                }, performanceBenchmark.testIterations);
            }, 1); // Very fast operation
        }

        function testRetryLogicPerformance() {
            if (!performanceBenchmark.systemAvailable.retryLogic) {
                addTestResult('Retry Logic Performance', 'SKIP', 'Retry logic system not available');
                return;
            }

            runBenchmarkTest('Retry Logic Performance', function() {
                return measureAsyncOperation('retry-logic-perf', function() {
                    return window.cuftRetryLogic.executeWithRetry('perf-test-operation', function() {
                        // Simulate successful operation
                        return 'success';
                    }, {
                        maxAttempts: 1,
                        baseDelay: 10
                    });

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.eventProcessing);
        }

        function testErrorBoundaryPerformance() {
            if (!performanceBenchmark.systemAvailable.errorBoundary) {
                addTestResult('Error Boundary Performance', 'SKIP', 'Error boundary system not available');
                return;
            }

            runBenchmarkTest('Error Boundary Performance', function() {
                return measureAsyncOperation('error-boundary-perf', function() {
                    // Test error boundary overhead
                    return window.cuftErrorBoundary.safeExecute(function() {
                        // Simulate normal form processing
                        var data = {
                            form_id: 'error-boundary-test',
                            processed_at: Date.now()
                        };
                        return data;
                    }, 'Error Boundary Performance Test');

                }, performanceBenchmark.testIterations);
            }, performanceBenchmark.thresholds.errorBoundaryOverhead);
        }

        // Utility functions
        function getMemoryUsage() {
            if (window.performance && window.performance.memory) {
                return window.performance.memory.usedJSHeapSize;
            }
            return 0;
        }

        function runBenchmarkTest(testName, testFunction, threshold, metricType) {
            addTestResult(testName, 'RUNNING', 'Starting performance benchmark...');

            testFunction().then(function(measurements) {
                var stats = metricType === 'memory' ?
                    calculateMemoryStatistics(measurements) :
                    calculateStatistics(measurements);

                var passed = evaluatePerformance(stats, threshold, metricType);
                var status = passed ? 'PASS' : 'FAIL';
                var message = formatBenchmarkMessage(stats, threshold, metricType);

                addTestResult(testName, status, message, {
                    statistics: stats,
                    threshold: threshold,
                    metricType: metricType,
                    rawMeasurements: measurements
                });

                updatePerformanceDisplay();

            }).catch(function(error) {
                addTestResult(testName, 'ERROR', 'Benchmark failed: ' + error.message);
            });
        }

        function calculateMemoryStatistics(measurements) {
            if (measurements.length === 0) {
                return { avgMemoryPerForm: 0, maxMemoryPerForm: 0, count: 0 };
            }

            var memoryPerFormValues = measurements.map(function(m) { return m.memoryPerForm || 0; });
            var sum = memoryPerFormValues.reduce(function(a, b) { return a + b; }, 0);

            return {
                avgMemoryPerForm: sum / memoryPerFormValues.length,
                maxMemoryPerForm: Math.max.apply(Math, memoryPerFormValues),
                count: measurements.length,
                totalMemoryDelta: measurements.reduce(function(sum, m) { return sum + (m.memoryDelta || 0); }, 0)
            };
        }

        function evaluatePerformance(stats, threshold, metricType) {
            if (metricType === 'memory') {
                return stats.avgMemoryPerForm <= threshold;
            } else {
                return stats.avg <= threshold;
            }
        }

        function formatBenchmarkMessage(stats, threshold, metricType) {
            if (metricType === 'memory') {
                var avgKB = Math.round(stats.avgMemoryPerForm / 1024 * 100) / 100;
                var thresholdKB = Math.round(threshold / 1024 * 100) / 100;
                return 'Average memory: ' + avgKB + 'KB/form (threshold: ' + thresholdKB + 'KB/form)';
            } else {
                return 'Average: ' + stats.avg.toFixed(2) + 'ms, P95: ' + stats.p95.toFixed(2) + 'ms (threshold: ' + threshold + 'ms)';
            }
        }

        function updatePerformanceDisplay() {
            var statsDiv = document.getElementById('performanceStats');
            var chartDiv = document.getElementById('timingChart');

            // Update statistics display
            var systemStats = checkSystemAvailability();
            var html = '';

            html += '<div class="perf-card"><h4>System Status</h4>';
            Object.keys(systemStats).forEach(function(system) {
                var status = systemStats[system] ? '‚úÖ Available' : '‚ùå Unavailable';
                html += '<div>' + system + ': ' + status + '</div>';
            });
            html += '</div>';

            // Performance measurements summary
            var measurementSummary = {};
            performanceBenchmark.measurements.forEach(function(measurements, name) {
                measurementSummary[name] = calculateStatistics(measurements);
            });

            Object.keys(measurementSummary).forEach(function(name) {
                var stats = measurementSummary[name];
                var threshold = getThresholdForMeasurement(name);

                html += '<div class="perf-card">';
                html += '<h4>' + name.replace(/-/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) + '</h4>';
                html += '<div class="metric-value">' + stats.avg.toFixed(2) + 'ms</div>';
                html += '<div class="metric-label">Average</div>';

                var status = threshold && stats.avg <= threshold ? 'pass' : threshold ? 'fail' : 'warning';
                var statusText = threshold ? (stats.avg <= threshold ? 'PASS' : 'FAIL') : 'NO THRESHOLD';

                html += '<div class="metric-status metric-' + status + '">' + statusText + '</div>';
                if (threshold) {
                    html += '<div class="metric-label">Threshold: ' + threshold + 'ms</div>';
                }
                html += '</div>';
            });

            statsDiv.innerHTML = html;

            // Update timing chart
            updateTimingChart(measurementSummary);
        }

        function getThresholdForMeasurement(name) {
            var thresholdMap = {
                'form-processing': performanceBenchmark.thresholds.formProcessing,
                'form-detection': performanceBenchmark.thresholds.formDetection,
                'field-extraction': performanceBenchmark.thresholds.fieldExtraction,
                'event-processing': performanceBenchmark.thresholds.eventProcessing,
                'observer-setup': performanceBenchmark.thresholds.observerSetup
            };
            return thresholdMap[name];
        }

        function updateTimingChart(measurementSummary) {
            var chartDiv = document.getElementById('timingChart');
            chartDiv.innerHTML = '';

            var measurements = Object.keys(measurementSummary);
            if (measurements.length === 0) return;

            var maxTime = Math.max.apply(Math, measurements.map(function(name) {
                return measurementSummary[name].max;
            }));

            var chartHeight = chartDiv.offsetHeight;
            var chartWidth = chartDiv.offsetWidth;
            var barHeight = Math.floor(chartHeight / measurements.length) - 4;

            measurements.forEach(function(name, index) {
                var stats = measurementSummary[name];
                var threshold = getThresholdForMeasurement(name);

                // Create bar for average time
                var barWidth = (stats.avg / maxTime) * (chartWidth - 100);
                var bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = '80px';
                bar.style.top = (index * (barHeight + 4)) + 'px';
                bar.style.width = barWidth + 'px';
                bar.style.height = barHeight + 'px';

                var passed = threshold && stats.avg <= threshold;
                bar.style.background = passed ? 'linear-gradient(90deg, #28a745, #20c997)' :
                                              'linear-gradient(90deg, #dc3545, #c82333)';

                bar.textContent = stats.avg.toFixed(1) + 'ms';
                chartDiv.appendChild(bar);

                // Create label
                var label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = '5px';
                label.style.top = (index * (barHeight + 4) + barHeight/2 - 6) + 'px';
                label.style.fontSize = '10px';
                label.style.color = '#333';
                label.textContent = name.replace(/-/g, ' ');
                chartDiv.appendChild(label);

                // Add threshold line if available
                if (threshold) {
                    var thresholdX = (threshold / maxTime) * (chartWidth - 100) + 80;
                    var thresholdLine = document.createElement('div');
                    thresholdLine.className = 'threshold-line';
                    thresholdLine.style.left = thresholdX + 'px';
                    thresholdLine.style.top = (index * (barHeight + 4)) + 'px';
                    thresholdLine.style.height = barHeight + 'px';
                    thresholdLine.style.width = '2px';
                    thresholdLine.style.borderTop = 'none';
                    thresholdLine.style.borderRight = '2px dashed #dc3545';
                    chartDiv.appendChild(thresholdLine);
                }
            });
        }

        function runAllBenchmarkScenarios() {
            clearResults();
            addTestResult('Performance Benchmark Suite', 'RUNNING', 'Starting comprehensive performance benchmarking...');

            var tests = [
                testFormProcessingSpeed,
                testFormDetectionSpeed,
                testFieldExtractionSpeed,
                testEventProcessingSpeed,
                testObserverSetupSpeed,
                benchmarkElementorPerformance,
                benchmarkCF7Performance,
                benchmarkNinjaPerformance,
                testMemoryOptimization,
                testErrorBoundaryPerformance
            ];

            tests.forEach(function(test, index) {
                setTimeout(test, index * 3000); // 3 second intervals
            });

            // Final report
            setTimeout(function() {
                generateBenchmarkReport();
            }, tests.length * 3000 + 2000);
        }

        function runStressTest() {
            addTestResult('Stress Test', 'RUNNING', 'Starting high-load performance stress test...');

            var stressConfig = {
                formCount: 50,
                concurrentForms: 10,
                iterations: 20
            };

            measureAsyncOperation('stress-test', function() {
                return new Promise(function(resolve) {
                    var container = document.getElementById('performance-test-forms');
                    var completedForms = 0;

                    // Create multiple forms concurrently
                    for (var i = 0; i < stressConfig.concurrentForms; i++) {
                        (function(formIndex) {
                            var form = document.createElement('form');
                            form.className = 'elementor-form stress-test-form-' + formIndex;
                            form.setAttribute('data-settings', '{"form_id":"stress-' + formIndex + '"}');

                            var emailInput = document.createElement('input');
                            emailInput.name = 'form_fields[email]';
                            emailInput.value = 'stress-test-' + formIndex + '@example.com';
                            form.appendChild(emailInput);

                            container.appendChild(form);

                            // Process form multiple times
                            var processCount = 0;
                            var processInterval = setInterval(function() {
                                if (processCount >= stressConfig.formCount / stressConfig.concurrentForms) {
                                    clearInterval(processInterval);
                                    completedForms++;

                                    // Cleanup form
                                    if (form.parentNode) {
                                        form.parentNode.removeChild(form);
                                    }

                                    if (completedForms >= stressConfig.concurrentForms) {
                                        resolve(completedForms);
                                    }
                                    return;
                                }

                                var event = new CustomEvent('submit_success', {
                                    bubbles: true,
                                    detail: {
                                        form: form,
                                        settings: { form_id: 'stress-' + formIndex + '-' + processCount }
                                    }
                                });
                                form.dispatchEvent(event);
                                processCount++;
                            }, 10);
                        })(i);
                    }
                });
            }, 1).then(function(measurements) {
                var stats = calculateStatistics(measurements);
                var totalProcessed = stressConfig.formCount;
                var avgProcessingTime = stats.avg / totalProcessed * 1000; // Convert to ms per form

                var passed = avgProcessingTime <= performanceBenchmark.thresholds.formProcessing;
                var status = passed ? 'PASS' : 'FAIL';
                var message = 'Processed ' + totalProcessed + ' forms, avg: ' + avgProcessingTime.toFixed(2) + 'ms/form';

                addTestResult('Stress Test', status, message, {
                    totalProcessed: totalProcessed,
                    avgProcessingTime: avgProcessingTime,
                    threshold: performanceBenchmark.thresholds.formProcessing
                });
            });
        }

        function startPerformanceBenchmark() {
            if (performanceBenchmark.isRunning) {
                stopPerformanceBenchmark();
                return;
            }

            performanceBenchmark.isRunning = true;
            checkSystemAvailability();
            updatePerformanceDisplay();

            addTestResult('Performance Monitoring', 'RUNNING', 'Performance monitoring started');
            document.querySelector('button[onclick="startPerformanceBenchmark()"]').textContent = 'Stop Performance Benchmark';
        }

        function stopPerformanceBenchmark() {
            performanceBenchmark.isRunning = false;
            document.querySelector('button[onclick="startPerformanceBenchmark()"]').textContent = 'Start Performance Benchmark';
            addTestResult('Performance Monitoring', 'STOPPED', 'Performance monitoring stopped');
        }

        function generateBenchmarkReport() {
            var passedTests = performanceBenchmark.results.filter(function(r) { return r.status === 'PASS'; }).length;
            var failedTests = performanceBenchmark.results.filter(function(r) { return r.status === 'FAIL'; }).length;
            var totalTests = passedTests + failedTests;

            var report = {
                timestamp: new Date().toISOString(),
                systemAvailability: performanceBenchmark.systemAvailable,
                testResults: {
                    total: totalTests,
                    passed: passedTests,
                    failed: failedTests,
                    successRate: totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0
                },
                performanceMetrics: {},
                complianceStatus: {},
                recommendations: []
            };

            // Calculate performance metrics
            performanceBenchmark.measurements.forEach(function(measurements, name) {
                report.performanceMetrics[name] = calculateStatistics(measurements);
            });

            // Check constitutional compliance
            Object.keys(performanceBenchmark.thresholds).forEach(function(metric) {
                var threshold = performanceBenchmark.thresholds[metric];
                var measurements = performanceBenchmark.measurements.get(metric.replace(/([A-Z])/g, '-$1').toLowerCase());

                if (measurements && measurements.length > 0) {
                    var stats = calculateStatistics(measurements);
                    report.complianceStatus[metric] = {
                        target: threshold,
                        actual: stats.avg,
                        compliant: stats.avg <= threshold
                    };
                }
            });

            // Generate recommendations
            var nonCompliantMetrics = Object.keys(report.complianceStatus).filter(function(metric) {
                return !report.complianceStatus[metric].compliant;
            });

            if (nonCompliantMetrics.length > 0) {
                report.recommendations.push('Performance optimization needed for: ' + nonCompliantMetrics.join(', '));
            }
            if (report.testResults.successRate < 80) {
                report.recommendations.push('Low test success rate - review failed benchmarks');
            }
            if (!performanceBenchmark.systemAvailable.performanceMonitor) {
                report.recommendations.push('Enable performance monitoring system for better tracking');
            }
            if (report.recommendations.length === 0) {
                report.recommendations.push('Performance targets met - system performing well');
            }

            var status = nonCompliantMetrics.length === 0 && report.testResults.successRate >= 80 ? 'SUCCESS' : 'WARNING';
            var message = 'Benchmark complete: ' + report.testResults.successRate + '% success rate, ' +
                         (Object.keys(report.complianceStatus).length - nonCompliantMetrics.length) + '/' +
                         Object.keys(report.complianceStatus).length + ' metrics compliant';

            addTestResult('Performance Benchmark Report', status, message, report);
        }

        function exportBenchmarkReport() {
            var report = {
                timestamp: new Date().toISOString(),
                systemAvailability: performanceBenchmark.systemAvailable,
                thresholds: performanceBenchmark.thresholds,
                measurements: {},
                testResults: performanceBenchmark.results
            };

            performanceBenchmark.measurements.forEach(function(measurements, name) {
                report.measurements[name] = {
                    rawData: measurements,
                    statistics: calculateStatistics(measurements)
                };
            });

            var blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'performance-benchmark-report-' + new Date().getTime() + '.json';
            a.click();
            URL.revokeObjectURL(url);

            addTestResult('Export Report', 'SUCCESS', 'Performance benchmark report exported');
        }

        function addTestResult(testName, status, message, details) {
            var result = {
                testName: testName,
                status: status,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };

            performanceBenchmark.results.push(result);

            var resultsDiv = document.getElementById('testResults');
            var resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' +
                (status === 'PASS' ? 'pass' :
                 status === 'FAIL' ? 'fail' :
                 status === 'WARNING' ? 'warning' : 'pending');

            var html = '<strong>' + testName + ':</strong> ' + status + ' - ' + message;

            if (details && details.statistics) {
                html += '<br><strong>Statistics:</strong> ';
                if (details.statistics.avg !== undefined) {
                    html += 'Avg: ' + details.statistics.avg.toFixed(2) + 'ms, ';
                }
                if (details.statistics.p95 !== undefined) {
                    html += 'P95: ' + details.statistics.p95.toFixed(2) + 'ms, ';
                }
                if (details.statistics.count !== undefined) {
                    html += 'Samples: ' + details.statistics.count;
                }
            }

            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('performance-test-forms').innerHTML = '';
            performanceBenchmark.results = [];
            performanceBenchmark.measurements.clear();
            updatePerformanceDisplay();
        }

        // Initialize performance benchmark system
        function initializePerformanceBenchmark() {
            checkSystemAvailability();
            updatePerformanceDisplay();

            addTestResult('Performance Benchmark System', 'READY', 'Ready to benchmark form tracking performance against constitutional targets');
        }

        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePerformanceBenchmark);
        } else {
            initializePerformanceBenchmark();
        }
    </script>
</body>
</html>